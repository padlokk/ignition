# RSB File System (MODERN + SPEC_ALIGNED)

Updated: 2025-09-15

Purpose
- Provide ergonomic, dependency-light file system helpers and macros for scripts and CLIs.
- Cover common operations: file I/O, directories, archives, path utilities, metadata extraction, and temp files.
- Keep implementation in `utils` and thin macros in `macros` per MODULE_SPEC.

Module Layout (SPEC)
- `src/fs/mod.rs` — Orchestrator only; re-exports curated surface and macros.
- `src/fs/utils.rs` — Implementation of fs helpers (read/write/mkdir/etc.).
- `src/fs/macros.rs` — Module-owned macros (thin wrappers over utils/streams/os).

Public API (curated)
- File I/O: `read_file`, `write_file`, `append_file`
- Directories: `mkdir_p`, `rm`, `rm_rf`, `cp`, `cp_r`, `mv`, `touch`
- Metadata: `extract_meta_from_file`, `backup_file`, `chmod`
- Path utils: `path_canon`, `path_split`, `parse_meta_keys`
- Predicates: `is_file`, `is_dir`, `is_entity`, `is_link`, `is_readable`, `is_writable`, `is_executable`, `is_nonempty_file`
- Dictionaries: `load_dict_from_file`
- Temp files: `create_temp_file_path`, `capture_stream_to_temp_file`, `cleanup_temp_files`
- File-based sed: `sed_lines_file`, `sed_around_file`, `sed_insert_file`, `sed_template_file`
- Counters (wc-like):
  - strings: `wc!(content) -> "lines words chars"`, `wc_lines!`, `wc_words!`, `wc_chars!`
  - files: `wc_file!(path)`, `wc_lines_file!`, `wc_words_file!`, `wc_chars_file!`
  - functions: `count_lines_str`, `count_words_str`, `count_chars_str` (string input) as well as `count_lines_file`, `count_words_file`, `count_chars_file`, and their streaming counterparts (`count_lines_file_stream`, `count_words_file_stream`, `count_chars_file_stream`). Tuple helpers (`wc_tuple_str`, `wc_tuple_file`, `wc_tuple_file_stream`) and render helpers (`wc_string`, `wc_file_string`, `wc_file_string_stream`) give you structured or preformatted output.

Macros (curated)
- Files/temp: `chmod!`, `backup!`, `tmp!`, `cap_stream!`, `subst!`
- Sed (string-based): `sed_lines!`, `sed_around!`, `sed_insert!`, `sed_template!`, `sed_replace!`
- Sed (file-based): `sed_lines_file!`, `sed_around_file!`, `sed_insert_file!`, `sed_template_file!`
- Archives: `tar!`, `tar_gz!`, `zip!`, `pack!`, `unpack!`
- Path/meta: `path_canon!`, `path_split!`, `meta_keys!`
- Dictionaries: `dict!("ARR", from: "path/to/file")`

Usage Examples
```rust
use rsb::fs::*;

// Write then read
write_file("/tmp/demo.txt", "hello\nworld");
let s = read_file("/tmp/demo.txt");

// Make a temp file and capture a stream into it
use rsb::streams::Stream;
let mut st = Stream::from_string("a\nb\nc");
let tmp = cap_stream!(st);

// Sed helpers (string-based)
let lines = sed_lines!("1\n2\n3\n4\n5", 2, 4); // "2\n3\n4"

// Archives
pack!("/tmp/archive.tar.gz", "/tmp/demo.txt");
unpack!("/tmp/archive.tar.gz", to: "/tmp/out");

// Path utilities
let parts = path_split("/home/me/file.txt");
```

Design Notes
- mod.rs contains only orchestration (no implementation) per MODULE_SPEC.
- Macros are thin and delegate to utils/streams/os; they are exported at crate root for compatibility.
- Error handling uses best-effort messages and `std::process::exit` where appropriate for scripting ergonomics.
- Temp files are tracked for cleanup via an internal registry; call `cleanup_temp_files()` on exit if needed.

Testing (HOWTO_TEST)
- No feature flags required. Covered by default test suite:
  - `cargo test`
  - Runner: `./bin/test.sh run smoke` (includes fs paths through sanity tests)

Status
- MODERN: Yes — utils in one place, macros are thin, curated surface.
- SPEC_ALIGNED: Yes — orchestrator-only `mod.rs`, module-owned `macros.rs`, documented and tested.

<!-- feat:fs -->

_Generated by bin/feat.py --update-doc._

* `src/fs/macros.rs`
  - macro chmod! (line 4)
  - macro backup! (line 11)
  - macro tmp! (line 18)
  - macro cap_stream! (line 28)
  - macro subst! (line 34)
  - macro dict! (line 42)
  - macro wc! (line 50)
  - macro wc_lines! (line 57)
  - macro wc_words! (line 64)
  - macro wc_chars! (line 71)
  - macro wc_file! (line 78)
  - macro wc_lines_file! (line 85)
  - macro wc_words_file! (line 92)
  - macro wc_chars_file! (line 99)
  - macro tar! (line 109)
  - macro tar_gz! (line 138)
  - macro zip! (line 149)
  - macro pack! (line 179)
  - macro unpack! (line 196)
  - macro path_canon! (line 223)
  - macro path_split! (line 230)
  - macro meta_keys! (line 241)

* `src/fs/mod.rs`
  - pub use utils::* (line 3)

* `src/fs/utils.rs`
  - fn read_file (line 13)
  - fn write_file (line 24)
  - fn append_file (line 45)
  - fn mkdir_p (line 88)
  - fn rm (line 92)
  - fn rm_rf (line 101)
  - fn cp (line 110)
  - fn cp_r (line 116)
  - fn mv (line 151)
  - fn touch (line 155)
  - fn extract_meta_from_file (line 171)
  - fn backup_file (line 189)
  - fn chmod (line 200)
  - fn chmod (line 207)
  - fn path_canon (line 213)
  - fn path_split (line 217)
  - fn parse_meta_keys (line 236)
  - fn is_file (line 257)
  - fn is_dir (line 260)
  - fn is_entity (line 263)
  - fn is_link (line 266)
  - fn is_readable (line 270)
  - fn is_writable (line 275)
  - fn is_executable (line 282)
  - fn is_executable (line 289)
  - fn is_nonempty_file (line 293)
  - fn load_dict_from_file (line 299)
  - fn count_lines_str (line 306)
  - fn count_words_str (line 311)
  - fn count_chars_str (line 316)
  - fn wc_tuple_str (line 321)
  - fn wc_string (line 326)
  - fn count_lines_file (line 332)
  - fn count_words_file (line 337)
  - fn count_chars_file (line 342)
  - fn wc_tuple_file (line 347)
  - fn wc_file_string (line 352)
  - fn count_lines_file_stream (line 358)
  - fn wc_tuple_file_stream (line 365)
  - fn wc_file_string_stream (line 382)
  - fn create_temp_file_path (line 386)
  - fn capture_stream_to_temp_file (line 399)
  - fn cleanup_temp_files (line 406)

<!-- /feat:fs -->
